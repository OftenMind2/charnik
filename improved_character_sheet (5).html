<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПРОМЕРЗШИЕ - Интерактивный лист персонажа v3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --primary-light: #64b5f6;
            --secondary-color: #81c784;
            --accent-color: #ff6b6b;
            --background-dark: #0a0a1a;
            --background-medium: #1a1a2e;
            --background-light: #16213e;
            --background-panel: rgba(255, 255, 255, 0.05);
            --text-color: #e8f4f8;
            --text-muted: #b0bec5;
            --text-accent: #ffffff;
            --danger-color: #f44336;
            --warning-color: #ffc107;
            --success-color: #28a745;
            --synergy-high: #28a745;
            --synergy-medium: #ffc107;
            --synergy-low: #f44336;
            --border-color: rgba(74, 144, 226, 0.3);
            --border-hover: rgba(100, 181, 246, 0.6);
            --shadow-glow: rgba(74, 144, 226, 0.2);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, var(--background-medium) 50%, var(--background-light) 100%);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
            line-height: 1.6;
        }

        .character-sheet {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(145deg, var(--background-medium) 0%, var(--background-dark) 100%);
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            box-shadow: 0 0 50px var(--shadow-glow);
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .character-sheet::before {
            content: '';
            position: absolute;
            top: 0; 
            left: 0; 
            right: 0; 
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light), var(--secondary-color), var(--primary-color));
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer { 
            0% { background-position: -200% 0; } 
            100% { background-position: 200% 0; } 
        }
        
        @keyframes flash-success {
            0% { background-color: rgba(40, 167, 69, 0); }
            50% { background-color: rgba(40, 167, 69, 0.4); }
            100% { background-color: rgba(40, 167, 69, 0); }
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 5px var(--primary-color); }
            50% { box-shadow: 0 0 20px var(--primary-color), 0 0 30px var(--primary-light); }
            100% { box-shadow: 0 0 5px var(--primary-color); }
        }

        .flash-success { 
            animation: flash-success 0.6s ease-out; 
        }

        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--primary-color); 
            padding-bottom: 20px; 
        }
        
        .header h1 { 
            font-family: 'Orbitron', monospace; 
            font-size: clamp(2rem, 5vw, 3.5rem); 
            color: var(--primary-light); 
            text-transform: uppercase; 
            letter-spacing: 4px; 
            margin-bottom: 10px; 
            text-shadow: 0 0 20px rgba(100, 181, 246, 0.8);
            background: linear-gradient(45deg, var(--primary-light), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p { 
            font-size: 1.2em; 
            color: var(--text-muted); 
            font-weight: 300; 
        }

        .main-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 25px; 
            margin-bottom: 25px; 
        }

        .section { 
            background: var(--background-panel); 
            border: 1px solid var(--border-color); 
            border-radius: 15px; 
            padding: 25px; 
            backdrop-filter: blur(15px); 
            transition: all 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .section:hover { 
            border-color: var(--border-hover); 
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .section:hover::before {
            opacity: 1;
        }
        
        .section h2 { 
            font-family: 'Orbitron', monospace; 
            color: var(--primary-light); 
            font-size: 1.4em; 
            margin-bottom: 20px; 
            text-transform: uppercase; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--secondary-color);
            border-radius: 2px;
        }

        .basic-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
        }

        .field { 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        .field label { 
            font-size: 0.9em; 
            color: var(--secondary-color); 
            margin-bottom: 8px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .field input, .field textarea, .field select { 
            background: rgba(0, 0, 0, 0.5); 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            padding: 12px 15px; 
            color: var(--text-color); 
            font-size: 1em; 
            font-family: 'Roboto', sans-serif; 
            transition: all 0.3s ease; 
            font-weight: 400;
        }
        
        .field input:focus, .field textarea:focus, .field select:focus { 
            outline: none; 
            border-color: var(--secondary-color); 
            box-shadow: 0 0 15px rgba(129, 199, 132, 0.4); 
            background: rgba(0, 0, 0, 0.7);
        }
        
        .advancement-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        
        .advancement-option { 
            background: rgba(0,0,0,0.3); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .advancement-option:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .advancement-option button { 
            width: 100%; 
            padding: 12px; 
            font-size: 0.9em; 
            font-weight: 600;
        }

        .buy-btn { 
            background: var(--success-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-family: 'Orbitron', monospace; 
            font-weight: bold; 
            transition: all 0.3s ease; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        
        .buy-btn:hover:not(:disabled) { 
            background: #218838; 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4); 
        }
        
        .buy-btn:disabled { 
            background: #555; 
            cursor: not-allowed; 
            box-shadow: none; 
            opacity: 0.6; 
        }

        .axes-section { 
            grid-column: 1 / -1; 
        }
        
        .axes-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
        }
        
        .axis { 
            text-align: center; 
            padding: 20px; 
            background: rgba(0, 0, 0, 0.3); 
            border-radius: 15px; 
            border: 1px solid var(--border-color); 
            transition: all 0.3s ease;
        }
        
        .axis:hover {
            border-color: var(--secondary-color);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .axis h3 { 
            font-family: 'Orbitron', monospace; 
            color: var(--secondary-color); 
            margin-bottom: 15px; 
            font-size: 1.2em; 
            font-weight: 700;
        }
        
        .axis-value-display { 
            font-size: 2.2em; 
            font-weight: bold; 
            color: var(--primary-light); 
            margin: 15px 0; 
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px var(--primary-color);
        }
        
        .axis-controls { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 15px; 
        }
        
        .axis-btn { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            font-weight: bold; 
            font-size: 1.3em; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            font-family: 'Orbitron', monospace;
        }
        
        .axis-btn:hover:not(:disabled) { 
            background-color: var(--primary-light); 
            transform: scale(1.15); 
            box-shadow: 0 0 15px var(--primary-color);
        }
        
        .axis-btn:disabled { 
            background-color: #555; 
            cursor: not-allowed; 
            opacity: 0.5; 
        }
        
        .axis-points { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 8px; 
            margin: 20px 0; 
            flex-wrap: wrap;
        }
        
        .axis-point { 
            width: 22px; 
            height: 22px; 
            border: 2px solid #6c7b7f; 
            border-radius: 50%; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: rgba(108, 123, 127, 0.1); 
            position: relative;
        }
        
        .axis-point:hover { 
            border-color: var(--primary-color); 
            transform: scale(1.2);
        }
        
        .axis-point.selected { 
            background: var(--primary-color); 
            border-color: var(--primary-light); 
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.6); 
            animation: pulse-glow 2s infinite;
        }
        
        .sterjni-section { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 30px; 
        }
        
        .sterjen { 
            background: rgba(129, 199, 132, 0.08); 
            border: 2px solid var(--secondary-color); 
            border-radius: 15px; 
            padding: 25px; 
            transition: all 0.3s ease; 
        }
        
        .sterjen:hover {
            background: rgba(129, 199, 132, 0.12);
            transform: translateY(-2px);
        }
        
        .sterjen h4 { 
            color: var(--secondary-color); 
            margin-bottom: 20px; 
            font-family: 'Orbitron', monospace; 
            font-size: 1.1em;
            font-weight: 700;
        }
        
        .sterjen-options { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .sterjen-group { 
            display: flex; 
            gap: 12px; 
            flex-wrap: wrap;
        }
        
        .sterjen-option { 
            padding: 12px 16px; 
            border: 2px solid; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.9em; 
            flex: 1; 
            text-align: center; 
            font-weight: 500;
            min-width: 120px;
        }
        
        .sterjen-option:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateY(-2px); 
        }
        
        .sterjen-option.synergy-high { 
            border-color: var(--synergy-high); 
            color: var(--synergy-high);
        }
        
        .sterjen-option.synergy-medium { 
            border-color: var(--synergy-medium); 
            color: var(--synergy-medium);
        }
        
        .sterjen-option.synergy-low { 
            border-color: var(--synergy-low); 
            color: var(--synergy-low);
            opacity: 0.8; 
        }
        
        .sterjen-option.selected { 
            background: var(--secondary-color); 
            color: var(--background-dark); 
            font-weight: 700; 
            box-shadow: 0 0 20px rgba(129, 199, 132, 0.5);
            border-color: var(--secondary-color) !important;
            opacity: 1;
        }
        
        .dice-section { 
            border: 2px solid var(--warning-color); 
            background: rgba(255, 193, 7, 0.05);
        }
        
        .dice-controls { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            align-items: end; 
        }
        
        .dice-controls .field { 
            grid-column: 1 / -1; 
        }
        
        .dice-buttons-container { 
            display: flex; 
            gap: 15px; 
            grid-column: 1 / -1; 
        }
        
        .dice-button { 
            color: var(--background-dark); 
            border: none; 
            padding: 15px 25px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-family: 'Orbitron', monospace; 
            font-weight: bold; 
            font-size: 1.1em; 
            transition: all 0.3s ease; 
            text-transform: uppercase; 
            flex: 1; 
            letter-spacing: 1px;
        }
        
        #roll-dice-btn { 
            background: var(--warning-color); 
        }
        
        #show-analysis-btn { 
            background: var(--primary-color); 
            color: white;
        }
        
        .dice-button:hover:not(:disabled) { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        #roll-dice-btn:hover:not(:disabled) { 
            background: #ffb300; 
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4); 
        }
        
        #show-analysis-btn:hover:not(:disabled) { 
            background: var(--primary-light); 
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4); 
        }

        .dice-result { 
            grid-column: 1 / -1; 
            margin-top: 25px; 
            padding: 25px; 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 15px; 
            border: 2px solid var(--warning-color); 
            display: none; 
        }
        
        .dice-result.visible { 
            display: block; 
            animation: slideInUp 0.5s ease;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .result-breakdown { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        
        .result-item { 
            text-align: center; 
            padding: 15px; 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 10px; 
            border: 1px solid var(--border-color);
        }
        
        .result-label { 
            font-size: 0.8em; 
            color: var(--text-muted); 
            margin-bottom: 8px; 
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .result-value { 
            font-size: 1.6em; 
            font-weight: bold; 
            color: var(--warning-color); 
            font-family: 'Orbitron', monospace;
        }
        
        .result-total { 
            text-align: center; 
            font-size: 2.2em; 
            font-weight: bold; 
            margin-bottom: 15px; 
            font-family: 'Orbitron', monospace;
        }
        
        .result-success { 
            color: var(--success-color); 
            text-shadow: 0 0 10px var(--success-color);
        }
        
        .result-failure { 
            color: var(--danger-color); 
            text-shadow: 0 0 10px var(--danger-color);
        }

        .formula-display { 
            margin-bottom: 30px; 
            padding: 20px; 
            background: rgba(74, 144, 226, 0.1); 
            border: 2px solid var(--primary-color); 
            border-radius: 15px; 
            font-family: 'Orbitron', monospace; 
            font-size: 0.9em; 
            text-align: center; 
        }
        
        .formula-display h4 { 
            color: var(--primary-light); 
            margin-bottom: 15px; 
            font-size: 1.2em;
        }
        
        .formula-text { 
            color: var(--secondary-color); 
            font-size: 1.3em; 
            word-spacing: 3px; 
            font-weight: 600;
        }

        .skills-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 12px; 
        }
        
        .skill { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 20px; 
            background: rgba(0, 0, 0, 0.3); 
            border-radius: 10px; 
            border-left: 4px solid var(--primary-color); 
            transition: all 0.3s ease;
        }
        
        .skill:hover {
            background: rgba(0, 0, 0, 0.4);
            transform: translateX(5px);
        }
        
        .skill-info { 
            flex: 1; 
        }
        
        .skill-name { 
            font-weight: 600; 
            color: var(--text-accent); 
            font-size: 1.05em; 
            margin-bottom: 4px;
        }
        
        .skill-description { 
            font-size: 0.85em; 
            color: var(--secondary-color); 
            font-style: italic; 
        }
        
        .skill-calculation { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 0.9em; 
        }
        
        .skill-bonus { 
            min-width: 70px; 
            text-align: center; 
            font-weight: bold; 
            color: var(--primary-light); 
            font-size: 1.5em; 
            font-family: 'Orbitron', monospace;
        }
        
        .skill-value { 
            width: 55px; 
            height: 40px; 
            background: rgba(74, 144, 226, 0.2); 
            border: 2px solid var(--primary-color); 
            border-radius: 8px; 
            text-align: center; 
            color: var(--secondary-color); 
            font-weight: bold; 
            font-family: 'Orbitron', monospace;
        }
        
        .upgrade-skill-btn { 
            background-color: var(--success-color); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            font-size: 1.4em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s ease-in-out; 
            margin-left: 8px; 
        }
        
        .upgrade-skill-btn:hover:not(:disabled) { 
            background-color: #218838; 
            transform: scale(1.15); 
            box-shadow: 0 0 15px var(--success-color);
        }
        
        .upgrade-skill-btn:disabled { 
            background-color: #555; 
            cursor: not-allowed; 
            opacity: 0.5; 
        }
        
        .dynamic-axes { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px;
        }
        
        .dynamic-axis { 
            text-align: center; 
            padding: 20px; 
            background: rgba(255, 87, 34, 0.1); 
            border: 2px solid var(--danger-color); 
            border-radius: 15px; 
            transition: all 0.3s ease;
        }
        
        .dynamic-axis:hover {
            background: rgba(255, 87, 34, 0.15);
            transform: translateY(-2px);
        }
        
        .dynamic-axis h4 { 
            color: #ff8a65; 
            margin-bottom: 15px; 
            font-family: 'Orbitron', monospace; 
            font-weight: 700;
        }
        
        .stats-display { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin: 30px 0; 
            padding: 25px; 
            background: rgba(255, 87, 34, 0.1); 
            border: 2px solid var(--danger-color); 
            border-radius: 20px; 
        }
        
        .stat-item { 
            text-align: center; 
            padding: 20px; 
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 15px; 
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            border-color: var(--danger-color);
        }
        
        .stat-label { 
            font-size: 0.9em; 
            color: #ff8a65; 
            font-weight: bold; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        
        .stat-value { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: var(--primary-light); 
            font-family: 'Orbitron', monospace; 
            text-shadow: 0 0 10px var(--primary-color);
        }
        
        .stat-description { 
            font-size: 0.75em; 
            color: var(--text-muted); 
            margin-top: 8px; 
        }

        .role-info-display { 
            margin-top: 25px; 
            padding: 25px; 
            background: rgba(129, 199, 132, 0.1); 
            border: 2px solid var(--secondary-color); 
            border-radius: 15px; 
            display: none; 
        }
        
        .role-info-display.visible { 
            display: block; 
        }
        
        .role-info-display h4 { 
            color: var(--secondary-color); 
            font-family: 'Orbitron', monospace; 
            margin-bottom: 15px; 
            font-weight: 700;
        }
        
        .role-info-display p { 
            font-size: 0.95em; 
            color: var(--text-muted); 
            line-height: 1.6; 
        }
        
        .role-info-display ul { 
            list-style: none; 
            margin-top: 15px; 
            padding-left: 0; 
        }
        
        .role-info-display li { 
            background: rgba(255, 255, 255, 0.08); 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            border-left: 3px solid var(--secondary-color);
        }
        
        .role-info-display li strong { 
            color: var(--text-accent); 
        }
        
        /* Tension Rules Table */
        .tension-rules {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--danger-color);
        }
        
        .tension-rules-header {
            background: var(--danger-color);
            color: white;
            padding: 15px 20px;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }
        
        .tension-rules-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .tension-rule-section {
            padding: 20px;
            border-right: 1px solid var(--border-color);
        }
        
        .tension-rule-section:last-child {
            border-right: none;
        }
        
        .tension-rule-section h5 {
            color: var(--secondary-color);
            font-family: 'Orbitron', monospace;
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
            padding: 10px;
            background: rgba(129, 199, 132, 0.1);
            border-radius: 8px;
        }
        
        .tension-rule-section.crisis h5 {
            color: var(--danger-color);
            background: rgba(244, 67, 54, 0.1);
        }
        
        .tension-rule-list {
            list-style: none;
            padding: 0;
        }
        
        .tension-rule-list li {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--secondary-color);
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .tension-rule-section.crisis .tension-rule-list li {
            border-left-color: var(--danger-color);
        }
        
        .tension-rule-list li strong {
            color: var(--text-accent);
            font-weight: 600;
        }
        
        .tooltip { 
            position: relative; 
            cursor: help; 
        }
        
        .tooltip::after { 
            content: attr(data-tooltip); 
            position: absolute; 
            background: rgba(26, 26, 46, 0.98); 
            color: var(--text-color); 
            padding: 12px 16px; 
            border-radius: 8px; 
            font-size: 0.85em; 
            z-index: 1000; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.3s ease; 
            border: 1px solid var(--primary-color); 
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); 
            pointer-events: none; 
            max-width: 350px; 
            white-space: normal; 
            line-height: 1.5; 
        }
        
        .tooltip:hover::after { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .tooltip.tooltip-top::after { 
            bottom: 100%; 
            left: 50%; 
            transform: translateX(-50%); 
            margin-bottom: 10px; 
        }

        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            opacity: 0; 
            visibility: hidden; 
            transition: all 0.3s ease; 
            backdrop-filter: blur(8px); 
        }
        
        .modal-overlay.visible { 
            opacity: 1; 
            visibility: visible; 
        }
        
        .modal-content { 
            background: var(--background-light); 
            padding: 35px; 
            border-radius: 20px; 
            border: 2px solid var(--primary-color); 
            text-align: center; 
            max-width: 500px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            margin: 20px;
        }
        
        .modal-content h3 { 
            font-family: 'Orbitron', monospace; 
            margin-bottom: 20px; 
            color: var(--primary-light);
            font-size: 1.3em;
        }
        
        .modal-content p { 
            margin-bottom: 25px; 
            font-size: 1.1em; 
            line-height: 1.6; 
        }
        
        .modal-content button { 
            padding: 12px 25px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 0 10px; 
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
        }
        
        #confirm-modal-yes, #alert-modal-ok, #close-analysis-modal-btn { 
            background-color: var(--primary-color); 
            color: white; 
        }
        
        #confirm-modal-no { 
            background-color: #6c757d; 
            color: white; 
        }
        
        .modal-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .analysis-modal-content { 
            max-width: 900px; 
            width: 95%; 
        }
        
        .chart-container { 
            position: relative; 
            height: 400px; 
            margin-bottom: 25px; 
        }
        
        .prob-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
        }
        
        .prob-table th, .prob-table td { 
            padding: 12px; 
            text-align: center; 
            border: 1px solid var(--border-color); 
        }
        
        .prob-table th { 
            background: rgba(74, 144, 226, 0.2); 
            color: var(--primary-light);
            font-family: 'Orbitron', monospace;
            font-weight: 600;
        }
        
        .modifiers-section { 
            margin-top: 25px; 
            padding: 25px; 
            background: rgba(0,0,0,0.3); 
            border-radius: 15px; 
            border: 2px solid var(--secondary-color); 
        }
        
        .modifiers-section h4 { 
            color: var(--secondary-color); 
            font-family: 'Orbitron', monospace; 
            margin-bottom: 20px; 
            font-weight: 700;
        }
        
        .modifiers-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px;
        }
        
        .modifier-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: rgba(255,255,255,0.05); 
            padding: 12px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border-left: 4px solid var(--text-muted); 
        }
        
        .modifier-item.active { 
            border-left-color: var(--secondary-color); 
            background: rgba(129, 199, 132, 0.15); 
        }
        
        .modifier-item:hover { 
            background: rgba(255,255,255,0.1); 
            transform: translateY(-2px);
        }
        
        .modifier-label { 
            font-size: 0.9em; 
            font-weight: 500;
        }
        
        .modifier-value { 
            font-weight: bold; 
            font-size: 1.1em; 
            font-family: 'Orbitron', monospace;
        }
        
        .modifier-value.positive { 
            color: var(--success-color); 
        }
        
        .modifier-value.negative { 
            color: var(--danger-color); 
        }
        
        .total-modifier-display { 
            margin-top: 25px; 
            text-align: center; 
            font-size: 1.3em; 
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .total-modifier-display span { 
            font-family: 'Orbitron', monospace; 
            font-size: 1.6em; 
            color: var(--secondary-color); 
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .main-grid, .axes-grid, .sterjni-section, .stats-display, .tension-rules-grid { 
                grid-template-columns: 1fr; 
            }
            
            .dice-controls { 
                grid-template-columns: 1fr; 
            }
            
            .dice-controls .field { 
                grid-column: 1; 
            }
        }
        
        @media (max-width: 768px) {
            .character-sheet {
                padding: 20px;
                margin: 10px;
            }
            
            .basic-info, .sterjen-group { 
                grid-template-columns: 1fr; 
                flex-direction: column; 
            }
            
            .result-breakdown { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            .dice-buttons-container { 
                flex-direction: column; 
            }
            
            .header h1 {
                font-size: 2rem;
                letter-spacing: 2px;
            }
            
            .axis-points {
                gap: 6px;
            }
            
            .axis-point {
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 480px) {
            .character-sheet {
                padding: 15px;
            }
            
            .section {
                padding: 20px;
            }
            
            .modifiers-grid {
                grid-template-columns: 1fr;
            }
            
            .advancement-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="character-sheet">
        <header class="header">
            <h1>ПРОМЕРЗШИЕ</h1>
            <p>Интерактивный лист персонажа v3.0</p>
        </header>

        <div class="main-grid">
            <section class="section">
                <h2>Основная информация</h2>
                <div class="basic-info">
                    <div class="field"><label>Имя</label><input type="text" id="name" placeholder="Введите имя"></div>
                    <div class="field"><label>Фамилия</label><input type="text" id="surname" placeholder="Введите фамилию"></div>
                    <div class="field"><label>Возраст</label><input type="number" id="age" placeholder="0"></div>
                    <div class="field"><label>Место рождения</label><input type="text" id="birthplace" placeholder="Город или регион"></div>
                    <div class="field"><label>Роль</label>
                        <select id="role">
                            <option value="">Выберите роль</option>
                            <option value="Маяк">Маяк</option>
                            <option value="Военный">Военный</option>
                            <option value="Корпорат">Корпорат</option>
                            <option value="Выживальщик">Выживальщик</option>
                            <option value="Медик">Медик</option>
                        </select>
                    </div>
                    <div class="field"><label>Северы (деньги)</label><input type="number" id="money" placeholder="0"></div>
                </div>
                <div id="role-info" class="role-info-display">
                    <h4>Пассивное преимущество</h4>
                    <p id="role-passive"></p>
                    <h4>Уникальные способности (для покупки)</h4>
                    <ul id="role-abilities-list"></ul>
                </div>
            </section>
            
            <section class="section">
                <h2>Опыт и Прокачка</h2>
                 <div class="field">
                    <label class="tooltip tooltip-top" data-tooltip="Источники ОО: -3 Напряжения (+2), действие по Стержню с риском (+1), успех на СЛ 16+ (+1), крит. успех (+1), завершение цели (+3).">Очки опыта (ОО) ⓘ</label>
                    <input type="number" id="experience" placeholder="0" value="0">
                </div>
                <div class="advancement-grid" style="margin-top: 20px;">
                    <div class="advancement-option">
                         <button id="buy-ability-btn" class="buy-btn">Купить способность роли</button>
                    </div>
                     <div class="advancement-option">
                         <button id="change-core-btn" class="buy-btn">Сменить стержень</button>
                    </div>
                     <div class="advancement-option" style="grid-column: 1 / -1;">
                         <button id="reset-advancement-btn" class="buy-btn" style="background-color: var(--danger-color);">Сбросить Прокачку</button>
                    </div>
                </div>
                <div class="field" style="margin-top: 20px;">
                    <label class="tooltip tooltip-top" data-tooltip="Способности, полученные за опыт.">Приобретенные способности</label>
                    <textarea id="role_abilities_bought" placeholder="Здесь будут отображаться купленные способности..." readonly></textarea>
                </div>
            </section>
        </div>

        <section class="section">
            <h2 class="tooltip tooltip-top" data-tooltip="Личная мотивация персонажа. Действия ради скрытой цели с личным риском дают -2 Напряжения.">Скрытая цель ⓘ</h2>
            <div class="field"><textarea id="hidden_goal" placeholder="Опишите скрытую мотивацию вашего персонажа..."></textarea></div>
        </section>

        <div class="formula-display">
            <h4>Формула проверки</h4>
            <div class="formula-text">d20 + [Бонусы от Осей] + [Навык] + [Модификаторы]</div>
        </div>

        <section class="section dice-section">
            <h2 style="color: #ffc107;" class="tooltip tooltip-top" data-tooltip="Система проверки навыков с автоматическим расчетом бонусов.">Проверка навыка ⓘ</h2>
            <div class="dice-controls">
                <div class="field"><label>Выберите навык</label>
                    <select id="skill-select"></select>
                </div>
                <div class="field"><label class="tooltip tooltip-top" data-tooltip="Сложность: 8, 11, 15, 18, 21, 25.">Сложность ⓘ</label>
                    <select id="difficulty-select">
                        <option value="8">Тривиально (8)</option>
                        <option value="11">Легко (11)</option>
                        <option value="15" selected>Средне (15)</option>
                        <option value="18">Сложно (18)</option>
                        <option value="21">Экстремально (21)</option>
                        <option value="25">Легендарно (25)</option>
                    </select>
                </div>
                <div class="dice-buttons-container">
                    <button class="dice-button" id="roll-dice-btn">Бросок d20</button>
                    <button class="dice-button" id="show-analysis-btn">Анализ</button>
                </div>
            </div>
            <div class="modifiers-section" id="modifiers-section">
                <h4>Калькулятор Модификаторов</h4>
                <div class="modifiers-grid" id="modifiers-grid">
                    <!-- Interactive modifiers will be inserted here -->
                </div>
                <div class="field" style="margin-top:20px;">
                    <label>Ситуативный модификатор (вручную)</label>
                    <input type="number" id="manual-modifier" value="0">
                </div>
                <div class="total-modifier-display">
                    Общий Модификатор: <span id="total-modifier-value">+0</span>
                </div>
            </div>
            <div class="dice-result" id="dice-result">
                <div class="result-breakdown">
                    <div class="result-item">
                        <div class="result-label">d20</div>
                        <div class="result-value" id="dice-roll">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">База (Оси+Навык)</div>
                        <div class="result-value" id="base-bonus-display">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Модификаторы</div>
                        <div class="result-value" id="total-modifier-display-result">-</div>
                    </div>
                </div>
                <div class="result-total" id="result-total">Итого: 0</div>
                <div style="text-align: center; font-size: 1.3em; font-weight: bold;" id="success-indicator">-</div>
            </div>
        </section>
        
        <section class="section">
            <h2 class="tooltip tooltip-top" data-tooltip="Главный эффект стержней - влияние на Напряжение и бонусы Синергии. Выберите по одному стержню из каждой категории.">Стержни личности ⓘ</h2>
            <div class="sterjni-section">
                 <div class="sterjen">
                    <h4>Стержень Движения</h4>
                    <div class="sterjen-options">
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="drive" data-value="справедливость">Справедливость</div><div class="sterjen-option" data-sterjen-type="drive" data-value="выгода">Выгода</div></div>
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="drive" data-value="истина">Истина</div><div class="sterjen-option" data-sterjen-type="drive" data-value="комфорт">Комфорт</div></div>
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="drive" data-value="защита">Защита</div><div class="sterjen-option" data-sterjen-type="drive" data-value="контроль_стержень">Контроль</div></div>
                    </div>
                </div>
                <div class="sterjen">
                    <h4>Стержень Метода</h4>
                     <div class="sterjen-options">
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="method" data-value="прямота">Прямота</div><div class="sterjen-option" data-sterjen-type="method" data-value="хитрость">Хитрость</div></div>
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="method" data-value="сотрудничество">Сотрудничество</div><div class="sterjen-option" data-sterjen-type="method" data-value="доминирование">Доминирование</div></div>
                        <div class="sterjen-group"><div class="sterjen-option" data-sterjen-type="method" data-value="терпение">Терпение</div><div class="sterjen-option" data-sterjen-type="method" data-value="импульсивность">Импульсивность</div></div>
                    </div>
                </div>
            </div>
        </section>

        <div class="stats-display">
            <div class="stat-item">
                <div class="stat-label tooltip tooltip-top" data-tooltip="Влияет на очередность хода. Рассчитывается от осей Контроль и Стабильность.">Инициатива ⓘ</div>
                <div class="stat-value" id="initiative-value">+0</div>
                <div class="stat-description">Контроль + Стабильность</div>
            </div>
            <div class="stat-item">
                <div class="stat-label tooltip tooltip-top" data-tooltip="Пункты здоровья. Рассчитывается как 6 + значение оси Здоровья.">Хит-поинты ⓘ</div>
                <div class="stat-value" id="hitpoints-value">6</div>
                <div class="stat-description">6 + Здоровье</div>
            </div>
            <div class="stat-item">
                <div class="stat-label tooltip tooltip-top" data-tooltip="Самый высокий бонус среди всех навыков.">Лучший навык ⓘ</div>
                <div class="stat-value" id="max-bonus-value">+0</div>
                <div class="stat-description">Макс. бонус</div>
            </div>
        </div>

        <section class="section axes-section">
            <h2 class="tooltip tooltip-top" data-tooltip="Основа личности персонажа. Определяют бонусы к навыкам. Нажмите на кнопки для изменения или расширения осей за ОО.">Психологические оси ⓘ</h2>
            <div class="axes-grid">
                <!-- Axes will be dynamically inserted here -->
            </div>
        </section>
        
        <div class="main-grid">
            <section class="section">
                <h2 class="tooltip tooltip-top" data-tooltip="Бонус = (Оси) + Навык + Противовес. Нажмите '+', чтобы улучшить навык за ОО.">Навыки ⓘ</h2>
                <div class="skills-grid" id="skills-container">
                    <!-- Skills will be dynamically inserted here by JavaScript -->
                </div>
            </section>

            <section class="section">
                <h2 class="tooltip tooltip-top" data-tooltip="Изменяемые характеристики, отражающие текущее состояние персонажа.">Динамические оси и Состояние ⓘ</h2>
                <div class="dynamic-axes">
                    <div class="dynamic-axis">
                        <h4 class="tooltip tooltip-bottom" data-tooltip="Температура тела. От -3 (замерзание) до +3 (перегрев).">Тепло ⓘ</h4>
                        <div class="axis-points" data-axis="temperature">
                            <div class="axis-point" data-value="-3"></div>
                            <div class="axis-point" data-value="-2"></div>
                            <div class="axis-point" data-value="-1"></div>
                            <div class="axis-point" data-value="0"></div>
                            <div class="axis-point" data-value="1"></div>
                            <div class="axis-point" data-value="2"></div>
                            <div class="axis-point" data-value="3"></div>
                        </div>
                    </div>
                    <div class="dynamic-axis">
                        <h4 class="tooltip tooltip-bottom" data-tooltip="Внутренний стресс. +3 - Кризис, -3 - Гармония.">Напряжение ⓘ</h4>
                        <div class="axis-points" data-axis="tension">
                            <div class="axis-point" data-value="-3"></div>
                            <div class="axis-point" data-value="-2"></div>
                            <div class="axis-point" data-value="-1"></div>
                            <div class="axis-point" data-value="0"></div>
                            <div class="axis-point" data-value="1"></div>
                            <div class="axis-point" data-value="2"></div>
                            <div class="axis-point" data-value="3"></div>
                        </div>
                    </div>
                    <div class="dynamic-axis">
                        <h4 class="tooltip tooltip-bottom" data-tooltip="Физическое состояние. Влияет на ХП.">Здоровье ⓘ</h4>
                        <div class="axis-points" data-axis="health" style="gap: 4px;">
                            <div class="axis-point" data-value="-5"></div>
                            <div class="axis-point" data-value="-4"></div>
                            <div class="axis-point" data-value="-3"></div>
                            <div class="axis-point" data-value="-2"></div>
                            <div class="axis-point" data-value="-1"></div>
                            <div class="axis-point" data-value="0"></div>
                            <div class="axis-point" data-value="1"></div>
                            <div class="axis-point" data-value="2"></div>
                            <div class="axis-point" data-value="3"></div>
                            <div class="axis-point" data-value="4"></div>
                            <div class="axis-point" data-value="5"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Tension Rules Table -->
                <div class="tension-rules">
                    <div class="tension-rules-header">
                        Правила Напряжения
                    </div>
                    <div class="tension-rules-grid">
                        <div class="tension-rule-section crisis">
                            <h5>КРИЗИС (+3 Напряжения)</h5>
                            <ul class="tension-rule-list">
                                <li><strong>Смена стержня:</strong> Изменить один стержень на противоположный (нельзя вернуться к предыдущему)</li>
                                <li><strong>Изменение оси:</strong> Сдвинуть одну из осей на ±1</li>
                                <li><strong>Отчаянная мера:</strong> Использовать одну из способностей + последствие</li>
                            </ul>
                        </div>
                        <div class="tension-rule-section">
                            <h5>ГАРМОНИЯ (-3 Напряжения)</h5>
                            <ul class="tension-rule-list">
                                <li><strong>Награда:</strong> Получить +2 ОО автоматически</li>
                                <li><strong>Осевая синхронизация:</strong> Все оси +1 к проверкам на одну сцену</li>
                                <li><strong>Вдохновляющий пример:</strong> Группа получает +2 к проверкам</li>
                                <li><strong>Интуитивное понимание:</strong> Задать мастеру один прямой вопрос о ситуации</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Подтверждение</h3>
            <p id="confirm-modal-text"></p>
            <div style="margin-top: 25px;">
                <button id="confirm-modal-yes">Да</button>
                <button id="confirm-modal-no">Нет</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay">
         <div class="modal-content">
            <h3 id="alert-modal-title"></h3>
            <p id="alert-modal-text"></p>
            <div style="margin-top: 25px;">
                <button id="alert-modal-ok">Понятно</button>
            </div>
        </div>
    </div>
    <div id="analysis-modal" class="modal-overlay">
        <div class="modal-content analysis-modal-content">
            <h3 id="analysis-modal-title">Анализ Вероятностей</h3>
            <div class="chart-container">
                <canvas id="probabilityChart"></canvas>
            </div>
            <div class="probability-table-container">
                <table class="prob-table">
                    <thead>
                        <tr><th>Сложность</th><th>DC</th><th>Нужно на d20</th><th>Шанс успеха (%)</th></tr>
                    </thead>
                    <tbody id="analysis-prob-table-body"></tbody>
                </table>
            </div>
            <button id="close-analysis-modal-btn" style="margin-top: 25px;">Закрыть</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: {
            axisValues: { energy: 0, decisions: 0, stability: 0, control: 0, temperature: 0, tension: 0, health: 0 },
            axisRanges: { energy: {min: -3, max: 3}, decisions: {min: -3, max: 3}, stability: {min: -3, max: 3}, control: {min: -3, max: 3} },
            sterjni: { drive: 'none', method: 'none' },
            abilitiesBought: [], 
            coresChanged: 0,
            xp: 0,
            activeModifiers: {}
        },

        config: {
            ABILITY_COST: 4,
            AXIS_UPGRADE_COST: 3,
            AXIS_EXPAND_COST: 4,
            CORE_CHANGE_COST: 6,
            SKILL_UPGRADE_COST: 2,
            MAX_SKILL_LEVEL: 5,
        },
        
        skillDefinitions: {
            thermoregulation: { name: 'Терморегуляция', desc: 'Способность поддерживать температуру тела.', rules: { stability: 'positive', control: 'positive' } },
            firstaid: { name: 'Первая помощь', desc: 'Оказание медицинской помощи.', rules: { stability: 'positive', decisions: 'neutral' } },
            survival: { name: 'Выживание в пустошах', desc: 'Поиск укрытия и ресурсов.', rules: { stability: 'negative', control: 'neutral' } },
            intuition: { name: 'Чутьё на опасность', desc: 'Способность предчувствовать угрозы.', rules: { stability: 'negative', energy: 'negative' } },
            negotiation: { name: 'Переговоры', desc: 'Торг, дипломатия, убеждение.', rules: { energy: 'positive', decisions: 'positive' } },
            deception: { name: 'Обман/Интрига', desc: 'Способность к обману, блефу, манипуляциям.', rules: { energy: 'positive', decisions: 'negative' } },
            reading: { name: 'Чтение людей', desc: 'Понимание мотивов, распознавание лжи.', rules: { decisions: 'positive', stability: 'negative' } },
            leadership: { name: 'Лидерство', desc: 'Руководство группой, вдохновение команды.', rules: { energy: 'positive', stability: 'positive' } },
            shooting: { name: 'Стрельба', desc: 'Владение огнестрельным оружием.', rules: { stability: 'positive', control: 'positive' } },
            melee: { name: 'Ближний бой', desc: 'Рукопашный бой, холодное оружие.', rules: { energy: 'positive', stability: 'neutral' } },
            tactics: { name: 'Тактика', desc: 'Планирование боевых операций.', rules: { decisions: 'negative', control: 'positive' } },
            stealth: { name: 'Скрытность', desc: 'Незаметное передвижение, маскировка.', rules: { energy: 'negative', control: 'neutral' } },
            repair: { name: 'Ремонт техники', desc: 'Ремонт механизмов, электроники.', rules: { decisions: 'negative', control: 'positive' } },
            analysis: { name: 'Анализ технологий', desc: 'Изучение неизвестных технологий.', rules: { decisions: 'negative', stability: 'positive' } },
            environmental_analysis: { name: 'Анализ среды', desc: 'Оценка местности, поиск укрытий, анализ окружающей среды.', rules: { decisions: 'negative', stability: 'negative' } },
            navigation: { name: 'Навигация', desc: 'Ориентирование на местности, карты.', rules: { decisions: 'neutral', control: 'neutral' } }
        },
        
        roleDefinitions: {
            'Медик': {
                passive: 'При проверке навыка "Первая помощь" вы можете добавить к броску дополнительный модификатор +1.',
                abilities: [ { name: 'Клятва Гиппократа', desc: '(1/сессия) Автостабилизация персонажа при смерти.' }, { name: 'Полевой диагноз', desc: '(1/сцена) Задать вопрос о физ. состоянии/уязвимостях существа.' }]
            },
            'Военный': {
                passive: 'В начале боя: либо +2 к своей инициативе, либо -2 на инициативу врага.',
                abilities: [ { name: 'За мной!', desc: '(1/сессия) Союзники +5 к проверке на страх/дух. Вы привлекаете внимание врагов.' }, { name: 'Подавляющий огонь', desc: '(1/бой) Заблокировать область (враги не движутся без проверки СЛ 18).' } ]
            },
            'Маяк': {
                passive: 'Раз за сессию в новом месте можно объявить, что «знаете тут одного человека», и завести полезный контакт.',
                 abilities: [ { name: 'Тайные тропы', desc: '(1/путешествие) Найти обходной путь, избежав опасности.' }, { name: 'Всегда есть сделка', desc: '(1/сессия) Предложить NPC сделку, от которой он не сможет отказаться.' } ]
            },
            'Выживальщик': {
                passive: 'В начале сцены в дикой местности задать Мастеру один вопрос об окружении.',
                abilities: [ { name: 'Одно целое с метелью', desc: '(1/сессия) Сделать группу (до 4 чел) необнаружимой на 10 мин.' }, { name: 'Из подручных средств', desc: '(1/сцена) Быстро создать/починить простой предмет (СЛ 13).' } ]
            },
            'Корпорат': {
                passive: 'Раз за сессию: либо скидка 50% на предмет, либо фрагмент коммерческой информации.',
                abilities: [ { name: 'Враждебное поглощение', desc: '(1/сессия) Заявить права на предмет NPC (Обман/Переговоры СЛ 16).' }, { name: 'Золотой парашют', desc: '(1/сессия) Потратить 1000с, чтобы аннулировать соц. последствия провала.' } ]
            }
        },

        synergyTable: {
            'справедливость': { 'energy': [-1, 0, 0, 0, 1, 1, 1], 'decisions': [-2, -1, 0, 0, 1, 1, 2], 'stability': [-1, 0, 0, 0, 1, 1, 1], 'control': [-1, 0, 0, 0, 1, 1, 1]},
            'выгода': { 'energy': [1, 1, 0, 0, 0, 0, 0], 'decisions': [2, 1, 1, 0, 0, -1, -2], 'stability': [1, 1, 0, 0, 0, 0, -1], 'control': [1, 1, 0, 0, 0, -1, -1]},
            'истина': { 'energy': [2, 1, 1, 0, 0, 0, 0], 'decisions': [2, 1, 1, 0, 0, -1, -1], 'stability': [2, 1, 1, 0, 1, 0, -2], 'control': [1, 0, 0, 0, 0, -1, -1]},
            'комфорт': { 'energy': [2, 1, 0, 0, 0, -1, -1], 'decisions': [1, 1, 0, 0, 0, -1, -1], 'stability': [2, 1, 1, 0, 0, -1, -1], 'control': [2, 1, 1, 0, 0, -1, -1]},
            'защита': { 'energy': [1, 1, 1, 0, 1, 1, 1], 'decisions': [2, 1, 1, 0, 1, 1, 1], 'stability': [2, 1, 1, 0, 1, 1, 1], 'control': [1, 1, 1, 0, 0, -1, -1]},
            'контроль_стержень': { 'energy': [2, 1, 0, 0, 0, -1, -2], 'decisions': [1, -1, 0, 0, 0, -1, -1], 'stability': [1, 0, 1, 0, 0, -1, -1], 'control': [2, 1, 1, 0, -1, -1, -2]},
            'прямота': { 'energy': [1, 1, 1, 0, 1, 1, 1], 'decisions': [-2, -1, 0, 0, 0, 1, 2], 'stability': [2, 1, 0, 0, 0, -1, -2], 'control': [2, 1, 0, 0, 0, -1, -2]},
            'хитрость': { 'energy': [-1, -1, 0, 0, 0, 0, 1], 'decisions': [-2, -1, 0, 0, 0, 1, 1], 'stability': [-1, -1, 0, 0, 0, 1, 2], 'control': [-2, -1, 0, 0, 0, 1, 2]},
            'сотрудничество': { 'energy': [2, 1, 1, 0, 1, -1, -1], 'decisions': [2, 1, 1, 0, 1, -1, -1], 'stability': [1, 0, 0, 0, 0, 1, 1], 'control': [1, 0, 0, 0, 0, 1, 1]},
            'доминирование': { 'energy': [2, 1, 0, 0, 0, -1, -2], 'decisions': [-1, -1, 0, 0, 0, 1, 1], 'stability': [1, 1, 1, 0, 0, -1, -2], 'control': [1, 1, 0, 0, 0, -1, -1]},
            'терпение': { 'energy': [-1, -1, 0, 0, 0, 1, 2], 'decisions': [1, 0, 0, 0, 0, 1, 2], 'stability': [2, 1, 1, 0, -1, -2, -2], 'control': [2, 1, 1, 0, -1, -2, -2]},
            'импульсивность': { 'energy': [1, 1, 0, 0, 0, -1, -1], 'decisions': [1, 1, 1, 0, -1, -1, -2], 'stability': [-2, -1, 0, 0, 0, 1, 2], 'control': [-2, 0, 0, 0, 0, 1, 2]}
        },
        
        axisPointTooltips: {
            energy: {"-4": "Абсолютный одиночка: +3 ко всем проверкам наедине, -3 к групповым.", "-3": "Крайний интроверт: -1 к лидерству, переговорам, стрельбе (противовес).", "-2": "Интроверт.", "-1": "Слегка интроверт.", "0": "Амбиверт.", "1": "Слегка экстраверт.", "2": "Экстраверт.", "3": "Крайний экстраверт: -1 к скрытности, анализу, чутью (противовес).", "4": "Вдохновляющий лидер: +2 к лидерству, +1 группе." },
            decisions: {"-4": "Гипер-логик: Недоступен для соц. проверок.", "-3": "Крайний логик: -1 к переговорам, чтению людей, лидерству (противовес).", "-2": "Логик.", "-1": "Слегка логик.", "0": "Сбалансированный.", "1": "Слегка эмпат.", "2": "Эмпат.", "3": "Крайний эмпат: -1 к ремонту, анализу, тактике (противовес).", "4": "Сверхэмпат: Может чувствовать эмоции группы."},
            stability: {"-4": "Паранойя: -2 ко всем соц. проверкам.", "-3": "Крайний нейротик: -1 к терморегуляции, стрельбе, ближнему бою (противовес).", "-2": "Нейротик.", "-1": "Слегка нейротик.", "0": "Нейтральный.", "1": "Слегка устойчивый.", "2": "Устойчивый.", "3": "Крайне устойчивый: -1 к чутью, выживанию (противовес).", "4": "Железная воля: Иммунитет к панике."},
            control: { "-4": "Интуитивный гений: +2 к решению неожид. проблем.", "-3": "Крайне спонтанный.", "-2": "Спонтанный.", "-1": "Слегка спонтанный.", "0": "Адаптивный.", "1": "Слегка структурированный.", "2": "Структурированный.", "3": "Крайне структурированный.", "4": "Мастер планирования: +2 к подготовленным действиям."},
            temperature: { "-3": "Замерзание: грань смерти, -3 ко всем действиям", "-2": "Сильный холод: -2 ко всем проверкам", "-1": "Дискомфорт: -1 к проверкам", "0": "Комфортная температура", "1": "Приятное тепло", "2": "Сильный жар: -1 к проверкам", "3": "Перегрев: -2 ко всем проверкам" },
            tension: { "-3": "Полная гармония: +2 ОО, доступ к особым способностям", "-2": "Глубокое спокойствие", "-1": "Внутренний баланс", "0": "Нейтральное состояние", "1": "Легкое беспокойство: -1 на проверки терпения/концентрации", "2": "Сильный стресс: -2 на проверки планирования/соц. взаимодействия", "3": "КРИЗИС: обязательная реакция" },
            health: { "-5": "Смерть", "-4": "При смерти", "-3": "Тяжелые ранения: -3 на физ. проверки", "-2": "Серьезные ранения: -2 на физ. проверки", "-1": "Легкие ранения: -1 на физ. проверки", "0": "Нормальное состояние", "1": "Хорошая форма", "2": "Отличная форма", "3": "Превосходная форма", "4": "Идеальная форма", "5": "Пиковая форма" }
        },
        
        elements: {},
        probabilityChartInstance: null,

        init() { this.cacheElements(); this.createDynamicElements(); this.bindEvents(); this.loadState(); this.render(); },
        cacheElements() {
            this.elements = {
                xpInput: document.getElementById('experience'),
                buyAbilityBtn: document.getElementById('buy-ability-btn'),
                changeCoreBtn: document.getElementById('change-core-btn'),
                resetBtn: document.getElementById('reset-advancement-btn'),
                initiativeValue: document.getElementById('initiative-value'),
                hitpointsValue: document.getElementById('hitpoints-value'),
                maxBonusValue: document.getElementById('max-bonus-value'),
                diceResult: document.getElementById('dice-result'),
                skillsContainer: document.getElementById('skills-container'),
                axesGrid: document.querySelector('.axes-grid'),
                rollDiceBtn: document.getElementById('roll-dice-btn'),
                roleSelect: document.getElementById('role'),
                roleInfo: document.getElementById('role-info'),
                rolePassive: document.getElementById('role-passive'),
                roleAbilitiesList: document.getElementById('role-abilities-list'),
                boughtAbilitiesTextarea: document.getElementById('role_abilities_bought'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalYes: document.getElementById('confirm-modal-yes'),
                confirmModalNo: document.getElementById('confirm-modal-no'),
                alertModal: document.getElementById('alert-modal'),
                alertModalTitle: document.getElementById('alert-modal-title'),
                alertModalText: document.getElementById('alert-modal-text'),
                alertModalOk: document.getElementById('alert-modal-ok'),
                analysisModal: document.getElementById('analysis-modal'),
                analysisModalTitle: document.getElementById('analysis-modal-title'),
                analysisProbTableBody: document.getElementById('analysis-prob-table-body'),
                showAnalysisBtn: document.getElementById('show-analysis-btn'),
                closeAnalysisBtn: document.getElementById('close-analysis-modal-btn'),
                probChartCanvas: document.getElementById('probabilityChart').getContext('2d'),
                skillSelect: document.getElementById('skill-select'),
                modifiersGrid: document.getElementById('modifiers-grid'),
                manualModifierInput: document.getElementById('manual-modifier'),
                totalModifierValue: document.getElementById('total-modifier-value'),
            };
        },
        createDynamicElements() {
            const skillsContainer = this.elements.skillsContainer;
            skillsContainer.innerHTML = '';
            const skillSelect = this.elements.skillSelect;
            skillSelect.innerHTML = '<option value="none">-- Выберите навык --</option>';

            Object.keys(this.skillDefinitions).forEach(key => {
                if (key === 'none') return;
                const skill = this.skillDefinitions[key];
                 const option = document.createElement('option');
                 option.value = key;
                 option.textContent = skill.name;
                 skillSelect.appendChild(option);

                const influenceText = Object.keys(skill.rules).map(axis => {
                    const type = skill.rules[axis] === 'positive' ? '(+)' : skill.rules[axis] === 'negative' ? '(-)' : '';
                    return `${axis.charAt(0).toUpperCase() + axis.slice(1)} ${type}`;
                }).join(', ');
                skillsContainer.innerHTML += `
                    <div class="skill" data-skill-key="${key}">
                        <div class="skill-info tooltip tooltip-right" data-tooltip="${skill.desc || 'Нет описания'}">
                            <div class="skill-name">${skill.name}</div>
                            <div class="skill-description">${influenceText || 'Нейтральный'}</div>
                        </div>
                        <div class="skill-calculation">
                            <div class="skill-bonus">+0</div>
                            <input type="number" class="skill-value" min="0" max="${this.config.MAX_SKILL_LEVEL}" value="0" data-skill-key="${key}">
                            <button class="upgrade-skill-btn" data-skill-key="${key}">+</button>
                        </div>
                    </div>`;
            });

            const axesGrid = this.elements.axesGrid;
            axesGrid.innerHTML = '';
            const axisDefs = {
                energy: { name: 'Энергия', sub: 'Интроверт ↔ Экстраверт' },
                decisions: { name: 'Решения', sub: 'Логик ↔ Эмпат'},
                stability: { name: 'Стабильность', sub: 'Нейротик ↔ Устойчивый'},
                control: { name: 'Контроль', sub: 'Спонтанный ↔ Структурированный'}
            };
            Object.keys(axisDefs).forEach(key => {
                const axis = axisDefs[key];
                 axesGrid.innerHTML += `
                    <div class="axis" data-axis-key="${key}">
                        <h3>${axis.name}</h3>
                        <div class="axis-controls">
                            <button class="axis-btn expand-min-btn" data-axis-key="${key}">&lt;</button>
                            <button class="axis-btn decrease-btn" data-axis-key="${key}">-</button>
                            <div class="axis-value-display">0</div>
                            <button class="axis-btn increase-btn" data-axis-key="${key}">+</button>
                            <button class="axis-btn expand-max-btn" data-axis-key="${key}">&gt;</button>
                        </div>
                        <div class="axis-points" data-axis="${key}"></div>
                         <p style="font-size: 0.8em; margin-top: 10px; color: var(--text-muted);">${axis.sub}</p>
                    </div>`;
            });
        },
        bindEvents() {
            this.elements.axesGrid.addEventListener('click', e => {
                const key = e.target.dataset.axisKey;
                if(!key) return;
                if (e.target.classList.contains('increase-btn')) this.upgradeAxis(key, 1);
                else if (e.target.classList.contains('decrease-btn')) this.upgradeAxis(key, -1);
                else if (e.target.classList.contains('expand-min-btn')) this.expandAxis(key, 'min');
                else if (e.target.classList.contains('expand-max-btn')) this.expandAxis(key, 'max');
            });
            
            document.querySelectorAll('.sterjen-option').forEach(el => {
                el.addEventListener('click', (e) => this.handleSterjenClick(e.currentTarget));
            });

            document.querySelectorAll('.axis-points').forEach(group => {
                group.addEventListener('click', e => {
                    if (e.target.classList.contains('axis-point')) {
                        const axis = group.dataset.axis;
                        const oldValue = this.state.axisValues[axis];
                        const newValue = parseInt(e.target.dataset.value);
                        if (oldValue !== newValue) {
                           this.state.axisValues[axis] = newValue;
                           if(axis === 'tension') this.checkTensionState(oldValue, newValue);
                           this.render();
                        }
                    }
                });
            });
            
            this.elements.skillSelect.addEventListener('change', () => this.render());
            this.elements.manualModifierInput.addEventListener('input', () => this.render());
            this.elements.modifiersGrid.addEventListener('click', (e) => {
                const item = e.target.closest('.modifier-item');
                if(item) {
                    const key = item.dataset.modifierKey;
                    this.state.activeModifiers[key] = !this.state.activeModifiers[key];
                    this.render();
                }
            });

            this.elements.buyAbilityBtn.addEventListener('click', () => this.buyAbility());
            this.elements.changeCoreBtn.addEventListener('click', () => this.changeCore());
            this.elements.resetBtn.addEventListener('click', () => this.resetAdvancement());
            this.elements.xpInput.addEventListener('input', () => { this.state.xp = parseInt(this.elements.xpInput.value) || 0; this.render(); });
            this.elements.skillsContainer.addEventListener('click', e => { if (e.target.classList.contains('upgrade-skill-btn')) this.upgradeSkill(e.target.dataset.skillKey); });
            document.querySelectorAll('input, textarea, select').forEach(input => {
                if(input.id !== 'manual-modifier') input.addEventListener('change', () => this.saveState());
            });
            this.elements.skillsContainer.addEventListener('input', e => { if(e.target.classList.contains('skill-value')) this.render(); });
            this.elements.rollDiceBtn.addEventListener('click', () => this.rollDice());
            this.elements.roleSelect.addEventListener('change', () => { this.state.abilitiesBought = []; this.render(); });
            this.elements.alertModalOk.addEventListener('click', () => this.hideAlert());
            this.elements.showAnalysisBtn.addEventListener('click', () => this.renderProbabilityAnalysis());
            this.elements.closeAnalysisBtn.addEventListener('click', () => this.elements.analysisModal.classList.remove('visible'));
        },
        
        calculateBonusesForCurrentCheck() {
            const skillKey = this.elements.skillSelect.value;
            if (!skillKey || skillKey === "none") {
                 return { baseBonus: 0, totalModifier: 0, modifiers: {} };
            }

            const skillDef = this.skillDefinitions[skillKey];
            const skillValue = parseInt(document.querySelector(`.skill-value[data-skill-key="${skillKey}"]`).value) || 0;

            let axisBonusToSkill = 0;
            const influencingAxes = Object.keys(skillDef.rules);
            influencingAxes.forEach(axisName => {
                const influence = skillDef.rules[axisName];
                const axisValue = this.state.axisValues[axisName] || 0;
                if (influence === 'positive') axisBonusToSkill += axisValue;
                else if (influence === 'negative') axisBonusToSkill -= axisValue;
            });
            
            const baseBonus = axisBonusToSkill + skillValue;
            
            // --- MODIFIERS ---
            let modifiers = {};

            // Synergy
            let synergyBonus = 0;
            ['drive', 'method'].forEach(type => {
                const selectedValue = this.state.sterjni[type];
                if (selectedValue && selectedValue !== 'none' && this.synergyTable[selectedValue]) {
                    influencingAxes.forEach(axisKey => {
                        const tableForAxis = this.synergyTable[selectedValue][axisKey];
                        if (tableForAxis) {
                            const index = Math.floor(Math.max(0, Math.min(6, this.state.axisValues[axisKey] + 3)));
                            synergyBonus += tableForAxis[index] || 0;
                        }
                    });
                }
            });
            if (synergyBonus !== 0) modifiers.synergy = { label: 'Синергия Стержней', value: synergyBonus };

            // Counterbalance
            let counterbalance = 0;
            if (this.state.axisValues.energy === 3 && ['stealth', 'analysis', 'intuition'].includes(skillKey)) counterbalance = -1;
            if (this.state.axisValues.energy === -3 && ['leadership', 'negotiation', 'shooting'].includes(skillKey)) counterbalance = -1;
            if (this.state.axisValues.decisions === 3 && ['repair', 'analysis', 'tactics'].includes(skillKey)) counterbalance = -1;
            if (this.state.axisValues.decisions === -3 && ['negotiation', 'reading', 'leadership'].includes(skillKey)) counterbalance = -1;
            if (this.state.axisValues.stability === 3 && ['intuition', 'survival'].includes(skillKey)) counterbalance = -1;
            if (this.state.axisValues.stability === -3 && ['thermoregulation', 'shooting', 'melee'].includes(skillKey)) counterbalance = -1;
            if (counterbalance !== 0) modifiers.counterbalance = { label: 'Противовес Осей', value: counterbalance };

            // Role Bonus
            if (this.elements.roleSelect.value === 'Медик' && skillKey === 'firstaid') {
                modifiers.role = { label: 'Бонус Роли', value: 1 };
            }

            // State Penalties (Temperature, Tension, Health)
            const temp = this.state.axisValues.temperature;
            const tension = this.state.axisValues.tension;
            const health = this.state.axisValues.health;
            if (temp <= -1 || temp >= 2) {
                let penalty = 0;
                if (temp === -1 || temp === 2) penalty = -1;
                if (temp === -2 || temp === 3) penalty = -2;
                if (temp === -3) penalty = -3;
                modifiers.temperature = { label: 'Штраф от Температуры', value: penalty };
            }
            if (tension > 0) {
                 modifiers.tension = { label: 'Штраф от Напряжения', value: -tension };
            }
            if (health < 0) {
                 modifiers.health = { label: 'Штраф от Ранений', value: health };
            }

            let totalModifier = parseInt(this.elements.manualModifierInput.value) || 0;
            Object.keys(modifiers).forEach(key => {
                if (this.state.activeModifiers[key] === undefined) {
                    this.state.activeModifiers[key] = true;
                }
                if (this.state.activeModifiers[key]) {
                    totalModifier += modifiers[key].value;
                }
            });

            return { baseBonus, totalModifier, modifiers };
        },
        handleSterjenClick(clickedOption) {
            const type = clickedOption.dataset.sterjenType;
            const value = clickedOption.dataset.value;
            this.state.sterjni[type] = this.state.sterjni[type] === value ? null : value;
            this.render();
        },
        buyAbility() {
            const role = this.elements.roleSelect.value;
            const roleDef = this.roleDefinitions[role];
            if (!roleDef || this.state.xp < this.config.ABILITY_COST) return;
            const unboughtAbilities = roleDef.abilities.filter(ab => !this.state.abilitiesBought.includes(ab.name));
            if (unboughtAbilities.length > 0) {
                const abilityToBuy = unboughtAbilities[0];
                 this.showConfirm(`Купить способность "${abilityToBuy.name}" за ${this.config.ABILITY_COST} ОО?`, () => {
                    this.state.xp -= this.config.ABILITY_COST;
                    this.state.abilitiesBought.push(abilityToBuy.name);
                    this.render();
                 });
            }
        },
        changeCore() {
             if (this.state.xp >= this.config.CORE_CHANGE_COST) {
                this.showConfirm(`Сменить стержень за ${this.config.CORE_CHANGE_COST} ОО?`, () => {
                    this.state.xp -= this.config.CORE_CHANGE_COST;
                    this.state.coresChanged++;
                    this.render();
                });
            }
        },
        upgradeSkill(skillKey) {
            const skillInput = document.querySelector(`.skill-value[data-skill-key="${skillKey}"]`);
            let currentLevel = parseInt(skillInput.value) || 0;
            if (currentLevel < this.config.MAX_SKILL_LEVEL && this.state.xp >= this.config.SKILL_UPGRADE_COST) {
                this.state.xp -= this.config.SKILL_UPGRADE_COST;
                skillInput.value = currentLevel + 1;
                skillInput.closest('.skill').classList.add('flash-success');
                setTimeout(() => skillInput.closest('.skill').classList.remove('flash-success'), 500);
                this.render();
            }
        },
        upgradeAxis(key, direction) {
            const { value, range } = { value: this.state.axisValues[key], range: this.state.axisRanges[key] };
            const newValue = value + direction;
            if (newValue <= range.max && newValue >= range.min && this.state.xp >= this.config.AXIS_UPGRADE_COST) {
                this.state.xp -= this.config.AXIS_UPGRADE_COST;
                this.state.axisValues[key] = newValue;
                this.render();
            }
        },
        expandAxis(key, type) {
            const range = this.state.axisRanges[key];
            if (this.state.xp < this.config.AXIS_EXPAND_COST) return;
            if (type === 'min' && range.min > -4) { range.min = -4; this.state.xp -= this.config.AXIS_EXPAND_COST; } 
            else if (type === 'max' && range.max < 4) { range.max = 4; this.state.xp -= this.config.AXIS_EXPAND_COST; }
            this.render();
        },
        resetAdvancement() {
            this.showConfirm("Сбросить весь прогресс? Все потраченные ОО будут возвращены.", () => {
                let refundedXp = 0;
                document.querySelectorAll('.skill-value').forEach(i => { refundedXp += (parseInt(i.value) || 0) * this.config.SKILL_UPGRADE_COST; });
                Object.keys(this.state.axisRanges).forEach(key => {
                    refundedXp += Math.abs(this.state.axisValues[key]) * this.config.AXIS_UPGRADE_COST;
                    if (this.state.axisRanges[key].min < -3) refundedXp += this.config.AXIS_EXPAND_COST;
                    if (this.state.axisRanges[key].max > 3) refundedXp += this.config.AXIS_EXPAND_COST;
                });
                refundedXp += this.state.abilitiesBought.length * this.config.ABILITY_COST;
                refundedXp += this.state.coresChanged * this.config.CORE_CHANGE_COST;
                this.state.xp += refundedXp;
                this.state.axisValues = { ...this.state.axisValues, energy: 0, decisions: 0, stability: 0, control: 0 };
                this.state.axisRanges = { energy: {min: -3, max: 3}, decisions: {min: -3, max: 3}, stability: {min: -3, max: 3}, control: {min: -3, max: 3} };
                this.state.abilitiesBought = [];
                this.state.coresChanged = 0;
                document.querySelectorAll('.skill-value').forEach(input => input.value = 0);
                this.render();
            });
        },
        showConfirm(text, onConfirm) {
            this.elements.confirmModalText.textContent = text;
            this.elements.confirmModal.classList.add('visible');
            const yesHandler = () => { onConfirm(); hide(); };
            const noHandler = () => hide();
            const hide = () => {
                this.elements.confirmModal.classList.remove('visible');
                this.elements.confirmModalYes.removeEventListener('click', yesHandler);
                this.elements.confirmModalNo.removeEventListener('click', noHandler);
            };
            this.elements.confirmModalYes.addEventListener('click', yesHandler);
            this.elements.confirmModalNo.addEventListener('click', noHandler);
        },
        showAlert(title, text) {
            this.elements.alertModalTitle.textContent = title;
            this.elements.alertModalText.innerHTML = text;
            this.elements.alertModal.classList.add('visible');
        },
        hideAlert() { this.elements.alertModal.classList.remove('visible'); },
        checkTensionState(oldValue, newValue) {
            if (newValue === 3 && oldValue !== 3) {
                this.showAlert('КРИЗИС!', 'Напряжение достигло максимума! Вы <strong>обязаны</strong> выбрать одно из действий в таблице "Правила Напряжения", чтобы сбросить напряжение.');
            } else if (newValue === -3 && oldValue !== -3) {
                this.showAlert('ГАРМОНИЯ!', 'Вы достигли полной гармонии! Вы получаете <strong>+2 ОО</strong> и можете выбрать одну из способностей в таблице "Правила Напряжения".');
                this.state.xp += 2;
            }
        },
        render() {
            this.updateXP();
            this.updateAxes();
            this.updateSterjniUI();
            this.calculateAllSkillBonuses();
            this.updateAllStats();
            this.updateUpgradeButtons();
            this.updateRoleInfo();
            this.renderModifierCalculator();
            this.saveState();
        },
        renderModifierCalculator() {
            const { baseBonus, totalModifier, modifiers } = this.calculateBonusesForCurrentCheck();
            
            this.elements.modifiersGrid.innerHTML = '';
            if (Object.keys(modifiers).length === 0) {
                this.elements.modifiersGrid.innerHTML = '<p style="color: var(--text-muted); font-style: italic; grid-column: 1 / -1; text-align: center; padding: 20px;">Нет доступных автоматических модификаторов для этой проверки.</p>';
            } else {
                 Object.keys(modifiers).forEach(key => {
                    const mod = modifiers[key];
                    // Ensure every modifier has a default state if not yet set
                    if (this.state.activeModifiers[key] === undefined) {
                        this.state.activeModifiers[key] = true;
                    }
                    const isActive = this.state.activeModifiers[key];
                    const valueClass = mod.value > 0 ? 'positive' : 'negative';
                    const itemHTML = `
                        <div class="modifier-item ${isActive ? 'active' : ''}" data-modifier-key="${key}" title="Нажмите, чтобы ${isActive ? 'отключить' : 'включить'} этот модификатор">
                            <span class="modifier-label">${mod.label}</span>
                            <span class="modifier-value ${valueClass}">${mod.value > 0 ? '+' : ''}${mod.value}</span>
                        </div>
                    `;
                    this.elements.modifiersGrid.innerHTML += itemHTML;
                });
            }
            this.elements.totalModifierValue.textContent = `${totalModifier >= 0 ? '+' : ''}${totalModifier}`;
        },
        updateXP() {
            this.elements.xpInput.value = this.state.xp;
            const role = this.elements.roleSelect.value;
            const roleDef = this.roleDefinitions[role];
            const canBuyAbility = roleDef && this.state.abilitiesBought.length < roleDef.abilities.length;
            this.elements.buyAbilityBtn.disabled = this.state.xp < this.config.ABILITY_COST || !canBuyAbility;
            this.elements.buyAbilityBtn.title = `Стоимость: ${this.config.ABILITY_COST} ОО`;
            this.elements.changeCoreBtn.disabled = this.state.xp < this.config.CORE_CHANGE_COST;
            this.elements.changeCoreBtn.title = `Стоимость: ${this.config.CORE_CHANGE_COST} ОО`;
        },
        updateAxes() {
            document.querySelectorAll('.axis').forEach(axisEl => {
                const key = axisEl.dataset.axisKey;
                const value = this.state.axisValues[key];
                const range = this.state.axisRanges[key];
                axisEl.querySelector('.axis-value-display').textContent = value >= 0 ? `+${value}` : value;
                axisEl.querySelector('.increase-btn').disabled = value >= range.max || this.state.xp < this.config.AXIS_UPGRADE_COST;
                axisEl.querySelector('.decrease-btn').disabled = value <= range.min || this.state.xp < this.config.AXIS_UPGRADE_COST;
                axisEl.querySelector('.expand-max-btn').disabled = range.max >= 4 || this.state.xp < this.config.AXIS_EXPAND_COST;
                axisEl.querySelector('.expand-min-btn').disabled = range.min <= -4 || this.state.xp < this.config.AXIS_EXPAND_COST;
                const pointsContainer = axisEl.querySelector('.axis-points');
                pointsContainer.innerHTML = '';
                for (let i = range.min; i <= range.max; i++) {
                    const point = document.createElement('div');
                    point.className = 'axis-point tooltip tooltip-top';
                    point.dataset.value = i;
                    point.dataset.tooltip = this.axisPointTooltips[key]?.[i] || `Значение: ${i}`;
                    if (i === value) point.classList.add('selected');
                    pointsContainer.appendChild(point);
                }
            });
            ['temperature', 'tension', 'health'].forEach(key => {
                 document.querySelectorAll(`.axis-points[data-axis="${key}"] .axis-point`).forEach(p => {
                    p.classList.toggle('selected', parseInt(p.dataset.value) === this.state.axisValues[key]);
                    p.dataset.tooltip = this.axisPointTooltips[key]?.[p.dataset.value] || `Значение: ${p.dataset.value}`;
                 });
            });
        },
        updateSterjniUI() {
            ['drive', 'method'].forEach(type => {
                document.querySelectorAll(`[data-sterjen-type="${type}"]`).forEach(opt => {
                    const coreValue = opt.dataset.value;
                    let generalSynergy = 0;

                    if (this.synergyTable[coreValue]) {
                        ['energy', 'decisions', 'stability', 'control'].forEach(axisKey => {
                            const tableForAxis = this.synergyTable[coreValue][axisKey];
                            if (tableForAxis) {
                                const axisValue = this.state.axisValues[axisKey];
                                const index = Math.floor(Math.max(0, Math.min(6, axisValue + 3)));
                                generalSynergy += tableForAxis[index] || 0;
                            }
                        });
                    }
                    
                    opt.classList.remove('synergy-high', 'synergy-medium', 'synergy-low');

                    if (generalSynergy >= 2) {
                        opt.classList.add('synergy-high');
                    } else if (generalSynergy >= 1) {
                        opt.classList.add('synergy-medium');
                    } else {
                        opt.classList.add('synergy-low');
                    }
                    
                    opt.classList.toggle('selected', coreValue === this.state.sterjni[type]);
                });
            });
        },
        calculateAllSkillBonuses() {
            document.querySelectorAll('.skill').forEach(skillEl => {
                const key = skillEl.dataset.skillKey;
                const skillDef = this.skillDefinitions[key];
                const skillInput = document.querySelector(`.skill-value[data-skill-key="${key}"]`);
                const skillValue = skillInput ? parseInt(skillInput.value) || 0 : 0;
                
                let axisBonus = 0;
                if (skillDef.rules) {
                    Object.keys(skillDef.rules).forEach(axisName => {
                        const influence = skillDef.rules[axisName];
                        const axisValue = this.state.axisValues[axisName];
                        if (influence === 'positive') axisBonus += axisValue;
                        else if (influence === 'negative') axisBonus -= axisValue;
                    });
                }
                const totalBonus = axisBonus + skillValue;
                const bonusEl = skillEl.querySelector('.skill-bonus');
                bonusEl.textContent = (totalBonus >= 0 ? '+' : '') + totalBonus;
            });
        },
        updateAllStats() {
            let initBonus = 0;
            const controlMap = { "-3": 4, "-2": 3, "-1": 2, "0": 0, "1": -1, "2": -2, "3": -3 };
            const stabilityMap = { "3": 3, "2": 2, "1": 1, "0": 0, "-1": -1, "-2": -2, "-3": -3 };
            initBonus += controlMap[this.state.axisValues.control] || 0;
            initBonus += stabilityMap[this.state.axisValues.stability] || 0;
            this.elements.initiativeValue.textContent = `${initBonus >= 0 ? '+' : ''}${initBonus}`;
            if (this.elements.roleSelect.value === 'Военный') this.elements.initiativeValue.textContent += ' (Пасс)';
            this.elements.hitpointsValue.textContent = 6 + this.state.axisValues.health;
            let maxBonus = -Infinity;
            document.querySelectorAll('.skill-bonus').forEach(el => { if (parseInt(el.textContent) > maxBonus) maxBonus = parseInt(el.textContent); });
            this.elements.maxBonusValue.textContent = (maxBonus >= 0 ? '+' : '') + (isFinite(maxBonus) ? maxBonus : '0');
        },
        updateUpgradeButtons() {
            this.state.xp = parseInt(this.elements.xpInput.value) || 0;
            document.querySelectorAll('.upgrade-skill-btn').forEach(btn => {
                const skillInput = document.querySelector(`.skill-value[data-skill-key="${btn.dataset.skillKey}"]`);
                const currentLevel = parseInt(skillInput.value) || 0;
                btn.disabled = currentLevel >= this.config.MAX_SKILL_LEVEL || this.state.xp < this.config.SKILL_UPGRADE_COST;
                btn.title = `Улучшить за ${this.config.SKILL_UPGRADE_COST} ОО`;
            });
            document.querySelectorAll('.axis-btn').forEach(btn => {
                if(btn.classList.contains('expand-min-btn') || btn.classList.contains('expand-max-btn')) btn.title = `Расширить за ${this.config.AXIS_EXPAND_COST} ОО`;
                else if(btn.classList.contains('increase-btn') || btn.classList.contains('decrease-btn')) btn.title = `Изменить за ${this.config.AXIS_UPGRADE_COST} ОО`;
            });
        },
        updateRoleInfo() {
            const role = this.elements.roleSelect.value;
            const roleDef = this.roleDefinitions[role];
            if (roleDef) {
                this.elements.roleInfo.classList.add('visible');
                this.elements.rolePassive.textContent = roleDef.passive;
                const abilitiesList = this.elements.roleAbilitiesList;
                abilitiesList.innerHTML = '';
                roleDef.abilities.forEach(ability => {
                    const isBought = this.state.abilitiesBought.includes(ability.name);
                    abilitiesList.innerHTML += `<li style="opacity:${isBought ? 0.6 : 1}"><strong>${ability.name} ${isBought ? '✅' : ''}</strong>: ${ability.desc}</li>`;
                });
                this.elements.boughtAbilitiesTextarea.value = this.state.abilitiesBought.join('\n');
            } else {
                this.elements.roleInfo.classList.remove('visible');
            }
        },
        rollDice() {
            const skillKey = this.elements.skillSelect.value;
            if (!skillKey || skillKey === "none") {
                this.showAlert('Ошибка', 'Пожалуйста, выберите навык для проверки.');
                return;
            }
            const diceRoll = Math.floor(Math.random() * 20) + 1;
            const { baseBonus, totalModifier } = this.calculateBonusesForCurrentCheck();
            const total = diceRoll + baseBonus + totalModifier;
            const difficulty = parseInt(document.getElementById('difficulty-select').value);
            const success = total >= difficulty;
            
            document.getElementById('dice-roll').textContent = diceRoll;
            document.getElementById('base-bonus-display').textContent = `${baseBonus >= 0 ? '+' : ''}${baseBonus}`;
            document.getElementById('total-modifier-display-result').textContent = `${totalModifier >= 0 ? '+' : ''}${totalModifier}`;
            
            const resultTotal = document.getElementById('result-total');
            resultTotal.textContent = `Итого: ${total}`;
            resultTotal.className = success ? 'result-total result-success' : 'result-total result-failure';
            document.getElementById('success-indicator').textContent = success ? 'УСПЕХ!' : 'ПРОВАЛ';
            this.elements.diceResult.classList.add('visible');
        },
        renderProbabilityAnalysis() {
            const skillKey = this.elements.skillSelect.value;
            if (!skillKey || skillKey === 'none') {
                 this.showAlert('Ошибка', 'Пожалуйста, выберите навык для анализа.');
                 return;
            }

            const { baseBonus, totalModifier } = this.calculateBonusesForCurrentCheck();
            const finalBonus = baseBonus + totalModifier;
            const skillName = this.skillDefinitions[skillKey].name;

            this.elements.analysisModalTitle.textContent = `Анализ шансов для: ${skillName} (Общий бонус ${finalBonus >= 0 ? '+' : ''}${finalBonus})`;

            const difficulties = [ { name: 'Тривиально', dc: 8 }, { name: 'Легко', dc: 11 }, { name: 'Средне', dc: 15 }, { name: 'Сложно', dc: 18 }, { name: 'Экстремально', dc: 21 }, { name: 'Легендарно', dc: 25 } ];
            const tableBody = this.elements.analysisProbTableBody;
            tableBody.innerHTML = '';
            difficulties.forEach(d => {
                const targetRoll = d.dc - finalBonus;
                const probability = (targetRoll > 20) ? 0 : (targetRoll <= 1) ? 100 : (21 - targetRoll) * 5;
                const row = `<tr><td>${d.name}</td><td>${d.dc}</td><td>${targetRoll > 20 ? 'Невозм.' : targetRoll <= 1 ? 'Авто' : targetRoll}</td><td>${probability.toFixed(0)}%</td></tr>`;
                tableBody.innerHTML += row;
            });
            
            if (this.probabilityChartInstance) {
                this.probabilityChartInstance.destroy();
            }

            const chartData = difficulties.map(d => (d.dc - finalBonus > 20) ? 0 : (d.dc - finalBonus <= 1) ? 100 : (21 - (d.dc - finalBonus)) * 5);
            const chartColors = ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336', '#9C27B0'];

            this.probabilityChartInstance = new Chart(this.elements.probChartCanvas, {
                type: 'bar',
                data: {
                    labels: difficulties.map(d => d.name),
                    datasets: [{
                        label: 'Вероятность успеха',
                        data: chartData,
                        backgroundColor: chartColors.map(c => c + 'BF'),
                        borderColor: chartColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#e8f4f8', callback: v => v + '%' } },
                        x: { ticks: { color: '#e8f4f8' } }
                    }
                }
            });

            this.elements.analysisModal.classList.add('visible');
        },
        saveState() {
            this.state.xp = parseInt(this.elements.xpInput.value) || 0;
            const skillValues = {};
            document.querySelectorAll('.skill-value').forEach(i => { skillValues[i.dataset.skillKey] = i.value; });
            const fieldValues = {};
             document.querySelectorAll('input[id], textarea[id], select[id]').forEach(field => {
                if(field.id !== 'role_abilities_bought') fieldValues[field.id] = field.value;
             });
            localStorage.setItem('promerzshieCharacterSheet_v7', JSON.stringify({ ...this.state, skills: skillValues, fields: fieldValues }));
        },
        loadState() {
            const savedData = JSON.parse(localStorage.getItem('promerzshieCharacterSheet_v7'));
            if (!savedData) return;
            this.state = { ...this.state, ...savedData, abilitiesBought: savedData.abilitiesBought || [], activeModifiers: savedData.activeModifiers || {} };
            if (savedData.skills) Object.keys(savedData.skills).forEach(key => { const i = document.querySelector(`.skill-value[data-skill-key="${key}"]`); if (i) i.value = savedData.skills[key]; });
            if (savedData.fields) Object.keys(savedData.fields).forEach(id => { const f = document.getElementById(id); if (f) f.value = savedData.fields[id]; });
        }
    };
    
    App.init();
});
    </script>
</body>
</html>